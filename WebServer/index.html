<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Login</title>
    <link rel="stylesheet" type="text/css" href="asset/css/semantic.css">
    <link rel="stylesheet" type="text/css" href="asset/css/common.css">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="asset/js/semantic.js"></script>
    <script src="asset/js/util.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="text/javascript">
        
    var getUerInfoBySession = async function( cbfunction ){
    
        var sid = getCookie("sid");
        if(!sid) return;

        var url = "/api/getUerInfoBySession"
        var method = "POST"
        var data = { sid : sid };
        var r = await asyncFetch_POST_JSONDATA( url, data )
        console.log( "getUerInfoBySession - r : ",r );
        
        return r;
        
    };

    var loadJSscript = function(id, js_src, callback) {
            if (document.getElementById(id)) { return; }
            var my_head = document.getElementsByTagName('head')[0];
            var my_js = document.createElement('script');
            my_js.id = id;
            my_js.type= 'text/javascript';
            my_js.async = true;
            my_js.src = js_src;
            my_js.addEventListener("load", function(event) { if(callback && typeof callback == "function"){ callback(); }});
            my_head.appendChild(my_js);
    };

    var loadCss = function(filename){
        var linkElement=document.createElement("link");
        linkElement.setAttribute("rel", "stylesheet");
        linkElement.setAttribute("type", "text/css");
        linkElement.setAttribute("href", filename);
        document.getElementsByTagName("head")[0].appendChild(linkElement);
    };

    var loadHtml = async function(targetDomId,filename){
        var html = await asyncFetch_GET("/getHtml?fileNm=" + filename);
        window.document.getElementById( targetDomId ).innerHTML = html;
        return html;
    };

    //render html;
    var render_loginBefore = async function(){
        console.log( "[S] - render_loginBefore" );
        await loadHtml("container","loginBefore");
        loadCss( "/asset/css/common.css" )
        loadJSscript('loginBefore','/thtml/loginBefore/loginBefore.js', function (){
            // if(typeof my_example_init == "function")
            // {
                //my_example_init();
                console.log("success")
            // } 
        });
        console.log( "[E] - render_loginBefore" );
    }

    var render_loginAfter = async function(){
        console.log( "[S] - render_loginAfter" );
        // var html = await asyncFetch_GET("/getHtml?fileNm=loginAfter");
        // console.log( html );
        // window.document.getElementById("container").innerHTML = html;
        loadJSscript('loginAfter','/thtml/loginAfter/loginAfter.js',function(){console.log("OK!")})
        console.log( "[E] - render_loginAfter" );
    }


    var render_addUserInfo = async function(){
        console.log( "[S] - renderAddUserInfo" );

        await loadHtml("container","addUserInfo");
        // loadCss( "/asset/css/common.css" )
        loadJSscript('addUserInfo','/thtml/addUserInfo/addUserInfo.js', function (){
            // if(typeof my_example_init == "function")
            // {
                //my_example_init();
                console.log("success")
            // } 
        });
        console.log( "[E] - renderAddUserInfo" );
    }

    var emailLogin = async function(){
        console.log( "[S] - emailLogin" );

        await loadHtml("container","emailLogin");
        // loadCss( "/asset/css/common.css" )
        loadJSscript('emailLogin','/thtml/emailLogin/emailLogin.js', function (){
            // if(typeof my_example_init == "function")
            // {
                //my_example_init();
                console.log("success")
            // } 
        });
        console.log( "[E] - emailLogin" );
    }

    var htmlToElement = function( html ){
        var template = document.createElement('template');
        html = html.trim(); // Never return a text node of whitespace as the result
        template.innerHTML = html;
        return template.content.firstChild;
    }
     
        
    var deleteAllCookies = function( name ) {

        if( name ) return document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";

        var cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
    };

    var checkSession = async function(){

        console.log( "[S] - checkSession" )
        
        var sid = await getCookie( "sid" );
        
        if( !sid || sid == "undefined" )
        { 
        
            window.localStorage.clear();
            await deleteSession();
            await deleteAllCookies();
            console.log( "   [MSG] - sid not found!" );
            console.log( "[E] - checkSession" );
            return false;
        }
        else
        {
            console.log( "sid : " + sid )
            var r = await asyncFetch_GET("http://localhost:8888/checksession?sid=" + sid);
            console.log( "   [Query Result] : " + JSON.stringify(r) );
            if( r ){
                console.log( "   [MSG] - session check complete!" );
                console.log( "[E] - checkSession" );
                return true;
            }
            else
            {
                //render_loginBefore();
                await window.localStorage.clear();
                await deleteSession();
                await deleteAllCookies();
                // location.href = "/";
                console.log( "   [MSG] - session check fail!!" );
                console.log( "[E] - checkSession" )
                return false;
            }
        }
    }

    var deleteSession = async function(){
        var sid = getCookie("sid");
        if( sid ){
            var r = await asyncFetch_GET("/api/deletesession?sid=" + sid);
            console.log( r ) ;
        }
    }

    var initPage = async function(){


        var urlStr = window.location.href;
        var url = new URL(urlStr);

        var urlParams = url.searchParams;

        var page = urlParams.get('p');

        // javascript
        console.log(page);

        if( page ){
            eval( "render_" + page + "();" );
        } 

        var a =  await checkSession();
        if( a )
        {            
            var s = await getUerInfoBySession()   
            
            function randomRgbaString (alpha) {
			let r = Math.floor(Math.random() * 255)
			let g = Math.floor(Math.random() * 255)
			let b = Math.floor(Math.random() * 255)
			let a = alpha
			return `rgba(${r},${g},${b},${a})`
		}

            if( s.profile_image == "" ) var profile_image = "data:image/svg+xml," + `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0,0,20,20' width='320' height='320'><rect height='20' width='20' fill='${randomRgbaString(100)}'/><text fill='white' x='10' y='14.8' font-size='14' font-family='-apple-system,BlinkMacSystemFont,Trebuchet MS,Roboto,Ubuntu,sans-serif' text-anchor='middle'>${s.username[1].toUpperCase()}</text></svg>`;
            else var profile_image = s.profile_image;
            
            var html = `
            <div class="column" style="max-width: 450px;">
            <h2 class="ui white header">
                <div class="content">
                <!-- <div>üîë</div> -->
                <!-- <div class="colorWhite"> ‚úàÔ∏è ÏïàÎÖïÌïòÏÑ∏Ïöî! Î∞òÍ∞ëÏäµÎãàÎã§~</div> -->
                <button id="badgeLoginBt" class="circular ui icon inverted button" style="padding: 10px;">
                    <img class="ui right spaced avatar image" src="${profile_image}">
            ${s.username }
                </button>

                </div>
            </h2>
            <!-- <div style="margin-bottom: 10px;">
                <div style="font-size: 1.3rem">Sign in</div>
                </div> -->
            <!-- <div id="logout" class="ui fluid inverted large submit button">Î°úÍ∑∏Ïù∏</div> -->
            </div>
            `;
            window.el.div.container.innerHTML = html;
            debugger;
            window.el.btn.badgeLoginBt = window.document.getElementById("badgeLoginBt");
                window.el.btn.badgeLoginBt.addEventListener("click",function(e){
                    debugger;
                    // console.log("remove");
                    // //window.el.btn.badgeLoginBt.removeEventListener("click",function(e){
                    //     console.log("add");
                        render_loginAfter();
                    // //})
                })
            return;
        }
        else
        {   
        //     render_loginBefore();
        //     return;
        // }

        var html = `
        <div class="column" style="max-width: 450px;">
        <h2 class="ui white header">
            <div class="content">
            <!-- <div>üîë</div> -->
            <!-- <div class="colorWhite"> ‚úàÔ∏è ÏïàÎÖïÌïòÏÑ∏Ïöî! Î∞òÍ∞ëÏäµÎãàÎã§~</div> -->
            <button id="badgeLoginBt" class="circular ui icon inverted button" style="padding: 10px;">
                ÏßÄÍ∏àÏãúÏûëÌïòÏÑ∏Ïöî!
            </button>

            </div>
        </h2>
        <!-- <div style="margin-bottom: 10px;">
            <div style="font-size: 1.3rem">Sign in</div>
            </div> -->
        <!-- <div id="logout" class="ui fluid inverted large submit button">Î°úÍ∑∏Ïù∏</div> -->
        </div>

        `;
        window.el.div.container.innerHTML = html;
        
        window.el.btn.badgeLoginBt = window.document.getElementById("badgeLoginBt");

        window.el.btn.badgeLoginBt.addEventListener("click", async function(evt){

            var a =  await checkSession();
            if( a )
            {            
                var s = await getUerInfoBySession()   
                var html = `
                <img class="ui right spaced avatar image" src="${s.userInfo.profile_image }">
                ${s.userInfo.nickname }
                `;
                window.el.btn.badgeLoginBt.innerHTML = html;


                return;
            }
            else
            {   
                render_loginBefore();
                return;
            }
        })
        }
    }



    window.addEventListener('DOMContentLoaded', function()
    {
        console.log( "index.html" )
        //https://tyrannocoding.tistory.com/51 <-- SSO Î°úÍ∑∏Ïù∏ Íµ¨ÌòÑÎ∞©Î≤ï ÏùΩÏñ¥Î≥¥Í∏∞!
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //REGEX;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //DOM element;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

        window.el = {};
        window.el.input = {};

        window.el.btn = {}
        
        window.el.div = {}
        window.el.div.container = window.document.getElementById("container");

        

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //Functions;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

    

        initPage();
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //Event;
        window.evt = {}

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        $('.custom.button').popup({
            popup : $('.custom.popup'),
            on    : 'click'
        });


    
    });
    //-------------------------------------------------------;
    //-------------------------------------------------------;
    // WebSocker Connect.
    //-------------------------------------------------------;
    //-------------------------------------------------------;
    
    var blobToText = function( blob ){
        return new Promise((resolve,reject) => {
            var reader = new FileReader();
		    reader.onload = function() {

			try
			{
                resolve(reader.result);
			}
			catch( er )
			{
                debugger;
                reject(er);
			}
			reader.onerror = reject;
		}
		reader.readAsText(blob);
        }) 
    }

    const webSocketHost = "localhost";
    const webSocketPort = 8889;

    const socket = new WebSocket(`ws://${webSocketHost}:${webSocketPort}`);
    socket.onopen = () => {
        console.log("WebSocket is open");
        //socket.send( "TEST" );
    };
    socket.onmessage = async (event) => {
        console.log("Message from server:", event.data);
        var r = await blobToText( event.data );
        console.log( r );
        
    };
    socket.onclose = () => {
        console.log("WebSocket is closed");
    };
    socket.onerror = (error) => {
    socket.close();
        console.log("WebSocket connection is closed due to:", error);
    };
    // socket.interval = setInterval(() => {
    //     //! ÏõπÏÜåÏºìÏùÄ ÎπÑÎèôÍ∏∞Ïù¥Í∏∞ ÎïåÎ¨∏Ïóê ÏÇë ÎÇ† Ïàò ÏûàÏñ¥, ÏõπÏÜåÏºìÏù¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Îûë Ïó∞Í≤∞Ïù¥ ÎêòÏóàÎäîÏßÄ Í≤ÄÏÇ¨ÌïòÎäî ÏïàÏ†Ñ Ïû•Ïπò
    //     if (socket.readyState !== socket.OPEN) {
    //         return;
    //     }
    //     // var sid = getCookie("sid");
    //     // var data = { type : "func", nm : "checksession", param : sid };
    //     // socket.send( JSON.stringify(data));
    // }, 5000);
    
    </script>
  </head>
  <body>
    <!-- <div class="ui stackable two column grid">
      <div class="column" style="background-image:url('https://cdn-624f2791c1ac184990d5b36b.closte.com/wp-content/uploads/2020/05/outdoor-rock-climbing-for-beginners-woman-sport-climbing--1638x2048.jpg');background-size: 100%;">

      </div>
      <div class="column"> -->
        <!-- <div id="naverIdLogin"><a id="naverIdLogin_loginButton" href="#" role="button"><img src="https://static.nid.naver.com/oauth/big_g.PNG" width=320></a></div> -->
    <div id="container" class="ui middle aligned center aligned grid" style="height: 100%;"></div>
    <div class="some-wrapping-div">
      <div class="ui custom button">Show custom popup</div>
    </div>
    <div class="ui custom popup top left transition hidden"  data-content="Bottom Center" data-position="bottom center">
      I'm not on the same level as the button, but i can still be found.
    </div>
      <!-- </div> -->
    <!-- </div> -->
  </body>
</html>
