<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Login</title>
    <link rel="stylesheet" type="text/css" href="asset/css/semantic.css">
    <link rel="stylesheet" type="text/css" href="asset/css/common.css">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="asset/js/semantic.js"></script>
    <script src="asset/js/util.js"></script>
    <script type="text/javascript">
var getCookie = function(name) {      
  var value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');     
   return value? value[2] : null;  
};
function getUerInfoBySession( cbfunction ){
      debugger;
      var sid = getCookie("sid");
      if(!sid) return;

      var url = "/api/getUerInfoBySession"
      var data = { sid : sid };
      requestPostBodyJson( url, data, function(d){
        console.log( d );
        cbfunction(d);
      })
			// ("/api/getUerInfoBySession?sid=" + sid,function(d){
			// 	// window.document.getElementById("container").innerHTML = d;
			// 	// requestGet("/getJs?fileNm=loginBefore",function(d){
			// 	// 	eval(d);
			// 	// })
      //   console.log( d );
			// })
		}
    function renderBeforeLogin(){
			requestGet("/getHtml?fileNm=loginBefore",function(d){
				window.document.getElementById("container").innerHTML = d;
				requestGet("/getJs?fileNm=loginBefore",function(d){
					eval(d);
				})
			})
		}

		function renderAfterLogin(){
			requestGet("/getHtml?fileNm=loginAfter",function(d){

        var _thtml = d;
        var html = "";
        getUerInfoBySession(function(d){
        
          var _d = JSON.parse(d);

          if( _d.userInfo.profile_image ) var imgsrc = _d.userInfo.profile_image
          else var imgsrc = "https://static.vecteezy.com/system/resources/thumbnails/020/765/399/small/default-profile-account-unknown-icon-black-silhouette-free-vector.jpg";

          if( _d.userInfo.name ) var name = _d.userInfo.name
          else var name = " - ";

          if( _d.userInfo.nickname ) var nickname = _d.userInfo.nickname
          else var nickname = " - ";

          if( _d.userInfo.email ) var email = _d.userInfo.email
          else var email = " - ";
          
          if( _d.userInfo.mobile ) var mobile = _d.userInfo.mobile
          else var mobile = " - ";

         
          html = _thtml.replace("{IMG_SRC}",imgsrc)
          .replace("{USER_NAME}",name)
          .replace("{NICK_NAME}",nickname)
          .replace("{EMAIL}",email)
          .replace("{MOBILE}", mobile);

          window.document.getElementById("container").innerHTML = html;
          requestGet("/getJs?fileNm=loginAfter",function(d){
					  eval(d);
				  })

        })
        
			})
		}



        function showClock(){
          var currentDate = new Date();
          var divClock = document.getElementById('divClock');
          var msg = "ÌòÑÏû¨ ÏãúÍ∞Ñ : ";
          if(currentDate.getHours()>12){      //ÏãúÍ∞ÑÏù¥ 12Î≥¥Îã§ ÌÅ¨Îã§Î©¥ Ïò§ÌõÑ ÏïÑÎãàÎ©¥ Ïò§Ï†Ñ
            msg += "Ïò§ÌõÑ ";
            msg += currentDate.getHours()-12+"Ïãú ";
          }
          else
          {
            msg += "Ïò§Ï†Ñ ";
            msg += currentDate.getHours()+"Ïãú ";
          }
    
          msg += currentDate.getMinutes()+"Î∂Ñ ";
          msg += currentDate.getSeconds()+"Ï¥à";
    
          divClock.innerText = msg;
    
            if (currentDate.getMinutes()>58)
            {   
              //Ï†ïÍ∞Å 1Î∂ÑÏ†ÑÎ∂ÄÌÑ∞ Îπ®Í∞ïÏÉâÏúºÎ°ú Ï∂úÎ†•
              divClock.style.color="red";
            }
            setTimeout(showClock,1000);  //1Ï¥àÎßàÎã§ Í∞±Ïã†
        }

        function getCookieToObject(){
          var _x = document.cookie.split( "; " );
          var i = 0,iLen = _x.length,io;
          var r = {};
          for(;i<iLen;++i){
            io = _x[ i ].split("=");
            r[ io[ 0 ] ] = io[ 1 ];
          }
          
          console.log( r );
          window._t = {};
          window._t.cookie = r;
          return r;
        }

        function getCookieToSid(){
          var _x = document.cookie.split( "; " );
          var i = 0,iLen = _x.length,io;
          var r = {};
          for(;i<iLen;++i){
            io = _x[ i ].split("=");
            r[ io[ 0 ] ] = io[ 1 ];
          }
          
          return r.sid;
        }

        var htmlToElement = function( html ){
          var template = document.createElement('template');
          html = html.trim(); // Never return a text node of whitespace as the result
          template.innerHTML = html;
          return template.content.firstChild;
        }
       
        


		var getMemberInfo = function(){
			var userId = window.localStorage.getItem("userId");
			var name = window.localStorage.getItem("name");
			return { userId : userId, name : name };
		}
        
        
        function deleteAllCookies( name ) {

			if( name ) return document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";

            var cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
				var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

        function checkSession(){
          console.log( "[S] - checkSession" )
          var sid = getCookie( "sid" );
          
          debugger;
          if( !sid || sid == "undefined" )
          { 
            console.log( "sid : " + sid )
            renderBeforeLogin();
            window.localStorage.clear();
            deleteSession();
            deleteAllCookies();
            //location.href = "/";
          }
          else
          {
            requestGet("http://localhost:8888/checksession?sid=" + sid, function(d){
              if( d ){
                console.log( "session check complete!")
                console.log( "[response] : ",d );
                renderAfterLogin();
              }
              else
              {
                //renderBeforeLogin();
                window.localStorage.clear();
                deleteSession();
                deleteAllCookies();
                location.href = "/";
              }
            });
          }
          console.log( "[E] - checkSession" )
        }

        function deleteSession(){
          var cookies = getCookieToObject();
          if( cookies.sid ){
            var isSesstion = requestGet("/api/deletesession?sid=" + cookies.sid, function(d){
              console.log( d );
            });
          }
        }

    function initPage(){
			

      var html = `
      <div class="column" style="max-width: 450px;">
				<h2 class="ui white header">
					<div class="content">
						<!-- <div>üîë</div> -->
						<!-- <div class="colorWhite"> ‚úàÔ∏è ÏïàÎÖïÌïòÏÑ∏Ïöî! Î∞òÍ∞ëÏäµÎãàÎã§~</div> -->
						<button id="badgeLoginBt" class="circular ui icon inverted button" style="padding: 10px;">
							<svg width="30" height="30" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" >
								<path fill-rule="evenodd" d="M17.5 9c0 1.14-.3 1.99-.79 2.54-.46.52-1.27.96-2.71.96s-2.25-.44-2.71-.96A3.74 3.74 0 0 1 10.5 9c0-1.14.3-1.99.79-2.54.46-.52 1.27-.96 2.71-.96s2.25.44 2.71.96c.5.55.79 1.4.79 2.54zM19 9c0 2.76-1.45 5-5 5s-5-2.24-5-5 1.45-5 5-5 5 2.24 5 5zm-8 8.5h6c2.04 0 3.1.5 3.76 1.1.69.63 1.11 1.55 1.5 2.8.13.42.04.95-.29 1.4-.33.46-.8.7-1.22.7H7.25c-.43 0-.89-.24-1.22-.7a1.61 1.61 0 0 1-.3-1.4 6.08 6.08 0 0 1 1.51-2.8c.65-.6 1.72-1.1 3.76-1.1zm6-1.5h-6c-4.6 0-5.88 2.33-6.7 4.96-.58 1.89.97 4.04 2.95 4.04h13.5c1.98 0 3.53-2.15 2.95-4.04C22.88 18.33 21.6 16 17 16z" fill="currentColor"></path>
							</svg>
						</button>

					</div>
				</h2>
				<!-- <div style="margin-bottom: 10px;">
					<div style="font-size: 1.3rem">Sign in</div>
				  </div> -->
				<!-- <div id="logout" class="ui fluid inverted large submit button">Î°úÍ∑∏Ïù∏</div> -->
			</div>
      `;
      window.el.div.container.innerHTML = html;
      window.el.btn.badgeLoginBt = window.document.getElementById("badgeLoginBt");
      window.el.btn.badgeLoginBt.addEventListener("click",function(evt){
      checkSession();
			//renderBeforeLogin();
		  })
		}
      window.addEventListener('DOMContentLoaded', function()
      {

        //https://tyrannocoding.tistory.com/51 <-- SSO Î°úÍ∑∏Ïù∏ Íµ¨ÌòÑÎ∞©Î≤ï ÏùΩÏñ¥Î≥¥Í∏∞!
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //REGEX;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //DOM element;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

        window.el = {};
        window.el.input = {};

        window.el.btn = {}
		    
        window.el.div = {}
        window.el.div.container = window.document.getElementById("container");

        

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //Functions;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;

		

		initPage();
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //Event;
		window.evt = {}

        //-------------------------------------------------------;
        //-------------------------------------------------------;
        //-------------------------------------------------------;
        $('.custom.button')
  .popup({
    popup : $('.custom.popup'),
    on    : 'click'
  })
;
      });
      
    </script>
    <script>

    </script>
  </head>
  <body>
    <!-- <div class="ui stackable two column grid">
      <div class="column" style="background-image:url('https://cdn-624f2791c1ac184990d5b36b.closte.com/wp-content/uploads/2020/05/outdoor-rock-climbing-for-beginners-woman-sport-climbing--1638x2048.jpg');background-size: 100%;">

      </div>
      <div class="column"> -->
        <!-- <div id="naverIdLogin"><a id="naverIdLogin_loginButton" href="#" role="button"><img src="https://static.nid.naver.com/oauth/big_g.PNG" width=320></a></div> -->
        <div id="container" class="ui middle aligned center aligned grid" style="height: 100%;">

			
		</div>
    <div class="some-wrapping-div">
      <div class="ui custom button">Show custom popup</div>
    </div>
    <div class="ui custom popup top left transition hidden"  data-content="Bottom Center" data-position="bottom center">
      I'm not on the same level as the button, but i can still be found.
    </div>
      <!-- </div> -->
    <!-- </div> -->
  </body>
</html>
